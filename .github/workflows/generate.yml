name: Generate Calendar

permissions:
  contents: write

on:
  push:
    branches: [main]
    paths:
      - data/**
      - docs/data/users.csv
      - config.json
      - scripts/**
      - .github/workflows/generate.yml
  workflow_dispatch:
    inputs:
      token:
        description: "User token from docs/data/users.csv"
        required: true
        type: string
      cycle_start:
        description: "Cycle start date (YYYY-MM-DD)"
        required: true
        type: string

jobs:
  build:
    if: github.event_name != 'push' || !contains(github.event.head_commit.message, '[skip calendar]')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Update cycle start
        if: github.event_name == 'workflow_dispatch'
        env:
          CYCLE_START: ${{ inputs.cycle_start }}
          USER_TOKEN: ${{ inputs.token }}
        run: |
          python3 - <<'PY'
          import json
          import os
          from datetime import datetime
          from pathlib import Path

          cycle_start = os.environ.get("CYCLE_START", "").strip()
          token = os.environ.get("USER_TOKEN", "").strip()
          if not cycle_start:
            raise SystemExit("cycle_start input is required")
          if not token:
            raise SystemExit("token input is required")
          datetime.strptime(cycle_start, "%Y-%m-%d")

          path = Path("data/users") / f"{token}.json"
          data = {}
          if path.exists():
            try:
              data = json.loads(path.read_text(encoding="utf-8"))
            except json.JSONDecodeError:
              data = {}

          history = data.get("history", [])
          if not isinstance(history, list):
            history = []
          if not history or history[-1] != cycle_start:
            history.append(cycle_start)

          data["last_period_start"] = cycle_start
          data["history"] = history
          path.parent.mkdir(parents=True, exist_ok=True)
          path.write_text(json.dumps(data, ensure_ascii=False, indent=2) + "\n", encoding="utf-8")
          PY

      - name: Generate calendars
        env:
          STATUS_SOURCE: ${{ github.event_name == 'workflow_dispatch' && 'workflow_dispatch' || 'schedule' }}
        run: python3 scripts/generate_ics.py

      - name: Validate output
        run: |
          test -f docs/calendar.ics
          test -d docs/cal
          test -d docs/data/users
          first_cal=$(find docs/cal -name '*.ics' | head -n 1)
          first_status=$(find docs/data/users -name '*.json' | head -n 1)
          if [ -z "$first_cal" ] || [ -z "$first_status" ]; then
            echo "Expected generated files for users"
            exit 1
          fi
          grep -q "BEGIN:VCALENDAR" "$first_cal"
          count=$(grep -c "BEGIN:VEVENT" "$first_cal")
          if [ "$count" -lt 300 ]; then
            echo "Expected at least 300 events, got $count"
            exit 1
          fi

      - name: Commit and push
        run: |
          DATE_FOR_COMMIT="${{ inputs.cycle_start }}"
          if [ -z "$DATE_FOR_COMMIT" ]; then
            DATE_FOR_COMMIT=$(date -u +%Y-%m-%d)
          fi
          git add -A
          if git diff --cached --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git commit -m "Update cycle data: ${DATE_FOR_COMMIT}"
          git push origin "HEAD:${{ github.ref_name }}"
